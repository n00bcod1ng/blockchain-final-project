<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Ledger View</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap4.min.css">
    
    <style>
        body { padding-top: 70px; background: #f8f9fa; }
        .card-body { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h4 { color: #343a40; margin-bottom: 20px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
        <a href="/" class="navbar-brand"> <i class="fa fa-link"></i> Prescription Blockchain</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a href="/" class="nav-link">Doctor Portal</a>
                </li>
                <li class="nav-item active">
                    <a href="/ledger" class="nav-link">Ledger View</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <div class="card-body text-center">
        <h4 class="card-title">Pending Transactions (Mempool)</h4>
        <button type="button" id="refresh_transactions" class="btn btn-primary btn-sm">
            <i class="fa fa-refresh"></i> Refresh
        </button>
    </div>

    <div class="card-body">
        <table id="unmined_transactions_table" class="table table-bordered table-striped" style="width:100%"></table>
        <div class="text-center mt-3">
            <button type="button" id="mine_button" class="btn btn-warning btn-lg">
                <i class="fa fa-cogs"></i> Mine Block
            </button>
        </div>
    </div>
</div>

<div class="container">
    <div class="card-body text-center">
        <h4 class="card-title">Committed Blockchain Ledger</h4>
        <button type="button" id="refresh_blockchain" class="btn btn-primary btn-sm">
            <i class="fa fa-refresh"></i> Refresh
        </button>
    </div>

    <div class="card-body">
        <table id="transactions_table" class="table table-bordered table-striped" style="width:100%"></table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap4.min.js"></script>

<script>
    $(function () {
        // Shared Network Key
        const NETWORK_KEY = "hospital-network-2025";

        function loadBlockchain() {
            $.ajax({
                url: "/chain",
                type: "GET",
                success: function (response) {
                    let prescriptions = [];
                    let count = 1;

                    for (let i = 0; i < response["length"]; i++) {
                        let block = response["chain"][i];
                        for (let j = 0; j < block["transactions"].length; j++) {
                            let p = block["transactions"][j];
                            let date = new Date(block["timestamp"] * 1000);
                            let formattedTimestamp = date.toLocaleString();

                            prescriptions.push([
                                count,
                                p["prescriber_public_key"],
                                p["pharmacy_public_key"],
                                p["patient_id"],
                                p["drug_name"],
                                p["dosage"] + " (" + p["quantity"] + ")",
                                formattedTimestamp,
                                block["block_number"]
                            ]);
                            count++;
                        }
                    }

                    if ($.fn.DataTable.isDataTable('#transactions_table')) {
                        $('#transactions_table').DataTable().clear().destroy();
                    }

                    $("#transactions_table").DataTable({
                        data: prescriptions,
                        columns: [
                            {title: "#"},
                            {title: "Prescriber"},
                            {title: "Pharmacy"},
                            {title: "Patient"},
                            {title: "Drug"},
                            {title: "Details"},
                            {title: "Time"},
                            {title: "Block"}
                        ]
                    });
                },
                error: function (error) { console.log(error); }
            });
        }

        function loadPending() {
            $.ajax({
                url: "/transactions/get",
                type: "GET",
                success: function (response) {
                    let prescriptions = [];
                    let count = 1;

                    for (let i = 0; i < response["transactions"].length; i++) {
                        let p = response["transactions"][i];
                        prescriptions.push([
                            count,
                            p["prescriber_public_key"],
                            p["pharmacy_public_key"],
                            p["patient_id"],
                            p["drug_name"],
                            p["quantity"]
                        ]);
                        count++;
                    }

                    if ($.fn.DataTable.isDataTable('#unmined_transactions_table')) {
                        $('#unmined_transactions_table').DataTable().clear().destroy();
                    }

                    $("#unmined_transactions_table").DataTable({
                        data: prescriptions,
                        columns: [
                            {title: "#"},
                            {title: "Prescriber"},
                            {title: "Pharmacy"},
                            {title: "Patient"},
                            {title: "Drug"},
                            {title: "Qty"}
                        ]
                    });
                },
                error: function (error) { console.log(error); }
            });
        }

        // --- BUTTON ACTIONS ---

        $("#mine_button").click(function () {
            // FIXED: Added network_key to the request
            $.ajax({
                url: "/mine",
                type: "GET",
                data: { network_key: NETWORK_KEY }, 
                success: function (response) {
                    alert("Block Mined Successfully!");
                    window.location.reload();
                },
                error: function (error) {
                    alert("Mining Failed: " + (error.responseJSON?.message || "Check console"));
                }
            });
        });

        $("#refresh_transactions").click(loadPending);
        $("#refresh_blockchain").click(loadBlockchain);

        // Initial Load
        loadBlockchain();
        loadPending();
    });
</script>

</body>
</html>